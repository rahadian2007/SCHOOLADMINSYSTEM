<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perbaikan CRUD ID Warga - React CDN</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 0 10px; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; font-size: 1rem; }
    button { cursor: pointer; }
    .btn-edit { color: blue; background: none; border: none; padding: 4px 8px; }
    .btn-delete { color: red; background: none; border: none; padding: 4px 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    tr:nth-child(even) { background: #f9f9f9; }
    .actions { display: flex; gap: 10px; }
    .spinner {
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #3498db; 
      border-radius: 50%; 
      width: 30px; 
      height: 30px; 
      animation: spin 1s linear infinite; 
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .button-group {
      display: flex;
      gap: 10px;
    }
    .button-group button {
      width: auto;
      flex: 1;
    }
    .error-message {
      color: red;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <h1>Perbaikan CRUD ID Warga (React CDN)</h1>
  <div id="root"></div>

  <!-- React & ReactDOM CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel CDN untuk JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">

  const { useState, useEffect } = React;
  const API_URL = 'http://139.59.224.22/api/ID-warga';

  function App() {
    const [data, setData] = useState([]);
    const [namaWarga, setNamaWarga] = useState('');
    const [editId, setEditId] = useState(null);
    const [loading, setLoading] = useState(false);
    const [errorMsg, setErrorMsg] = useState('');

    // Fetch semua data
    const fetchData = () => {
      setLoading(true);
      setErrorMsg('');
      fetch(API_URL)
        .then(res => {
          if(!res.ok) throw new Error(`Error: ${res.status}`);
          return res.json();
        })
        .then(json => setData(json))
        .catch(err => setErrorMsg('Gagal fetch data: ' + err.message))
        .finally(() => setLoading(false));
    };

    useEffect(() => {
      fetchData();
    }, []);

    // Submit tambah atau update
    const handleSubmit = (e) => {
      e.preventDefault();
      if (!namaWarga.trim()) {
        setErrorMsg('Nama Warga harus diisi');
        return;
      }

      setLoading(true);
      setErrorMsg('');

      const method = editId ? 'PUT' : 'POST';
      const url = editId ? `${API_URL}/${editId}` : API_URL;

      fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ Nama_Warga: namaWarga })
      })
      .then(res => {
        if(!res.ok) throw new Error(`Error: ${res.status}`);
        return res.json();
      })
      .then(() => {
        alert(editId ? 'Data berhasil diperbarui' : 'Data berhasil ditambahkan');
        setNamaWarga('');
        setEditId(null);
        fetchData();
      })
      .catch(err => setErrorMsg((editId ? 'Gagal update: ' : 'Gagal tambah data: ') + err.message))
      .finally(() => setLoading(false));
    };

    // Edit mode
    const handleEdit = (item) => {
      setEditId(item.ID);
      setNamaWarga(item.Nama_Warga);
    };

    // Delete
    const handleDelete = (id) => {
      if (!confirm('Yakin ingin menghapus data ini?')) return;

      setLoading(true);
      setErrorMsg('');

      fetch(`${API_URL}/${id}`, { method: 'DELETE' })
        .then(async (res) => {
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.message || `Gagal hapus data (status ${res.status})`);
          }
          return res.json();
        })
        .then(data => {
          alert(data.message || 'Data berhasil dihapus');
          fetchData();
        })
        .catch(err => setErrorMsg('Gagal hapus: ' + err.message))
        .finally(() => setLoading(false));
    };

    // Cancel edit
    const handleCancel = () => {
      setEditId(null);
      setNamaWarga('');
      setErrorMsg('');
    };

    return (
      <div>
        <form onSubmit={handleSubmit}>
          <label htmlFor="namaWarga">Nama Warga:</label>
          <input
            id="namaWarga"
            type="text"
            value={namaWarga}
            onChange={e => setNamaWarga(e.target.value)}
            required
            disabled={loading}
            placeholder="Masukkan nama warga"
          />
          <div className="button-group">
            <button type="submit" disabled={loading}>
              {editId ? 'Update' : 'Tambah'}
            </button>
            {editId && 
              <button type="button" onClick={handleCancel} disabled={loading}>
                Batal
              </button>
            }
          </div>
        </form>

        {errorMsg && <p className="error-message">{errorMsg}</p>}

        {loading ? (
          <div className="spinner" aria-label="Loading"></div>
        ) : (
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nama Warga</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>
              {data.length === 0 ? (
                <tr><td colSpan="3" style={{textAlign:'center'}}>Data kosong</td></tr>
              ) : (
                data.map(item => (
                  <tr key={item.ID}>
                    <td>{item.ID}</td>
                    <td>{item.Nama_Warga}</td>
                    <td className="actions">
                      <button className="btn-edit" onClick={() => handleEdit(item)} disabled={loading}>Edit</button>
                      <button className="btn-delete" onClick={() => handleDelete(item.ID)} disabled={loading}>Hapus</button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        )}
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);

  </script>

</body>
</html>
